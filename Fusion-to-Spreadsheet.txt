var tableID = '2178714' // Add the table ID of the fusion table here

function onOpen() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var menuEntries = [ {name: "Update Spreadsheet", functionName: "updateSpreadsheet"}, 
                      {name: "Change Email Information", functionName: "fixEmail"},
                      {name: "Select Cell Where Import Starts (This will be the line with headers)", functionName: "setRangeUpdateSpread"}];
  ss.addMenu("Fusion to Spreadsheet", menuEntries);
}
    
function updateSpreadsheet() {
  var email = UserProperties.getProperty('email');
  var password = UserProperties.getProperty('password');

  if (email === null || password === null) {
    email = Browser.inputBox('Enter email');
    password = Browser.inputBox('Enter password');
    UserProperties.setProperty('email',email);
    UserProperties.setProperty('password', password);
  } else {
    email = UserProperties.getProperty('email');
    password = UserProperties.getProperty('password');
  }

  //select Data
  var authToken = getGAauthenticationToken(email,password);
  var query = encodeURIComponent("SELECT * FROM " + tableID);
  var URL = "http://www.google.com/fusiontables/api/query?sql=" + query;

  var responseCsv = UrlFetchApp.fetch(URL, {
     method: "get",
     headers: {
          "Authorization": "GoogleLogin auth=" + authToken,
     }
  });
  
  var resParse  = Utilities.parseCsv(responseCsv.getContentText());
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var range = ss.getRangeByName('updateSpreadsheet')
  range = range.getCell(1,1)
  for (var i in resParse) {
    for (var j in resParse[i]) {
      range.offset(i, j).setValue(resParse[i][j]);
    }
  }
}

//Google Authentication API
function getGAauthenticationToken(email, password) {
  password = encodeURIComponent(password);
  var response = UrlFetchApp.fetch("https://www.google.com/accounts/ClientLogin", {
    method: "post",
    payload: "accountType=GOOGLE&Email=" + email + "&Passwd=" + password + "&service=fusiontables&Source=testing"
  });
  var responseStr = response.getContentText();
  responseStr = responseStr.slice(responseStr.search("Auth=") + 5, responseStr.length);
  responseStr = responseStr.replace(/\n/g, "");
  return responseStr;
}

//change email if needed
function fixEmail() {
   var decision = Browser.msgBox("WARNING", "Are you sure you want to change your email?", Browser.Buttons.YES_NO);
   if (decision == 'yes'){
     var email = Browser.inputBox('Enter email');
     var password = Browser.inputBox('Enter password');
     UserProperties.setProperty('email',email);
     UserProperties.setProperty('password', password);
   }
}

//set cell start range
function setRangeUpdateSpread() {
   var decision = Browser.msgBox("WARNING", "Are you sure you want to change the start cell to Update the Spreadsheet?", Browser.Buttons.YES_NO);
   if (decision == 'yes'){
     var ss = SpreadsheetApp.getActiveSpreadsheet();
     var range = SpreadsheetApp.getActiveRange()
     ss.setNamedRange("updateSpreadsheet", range);
     Browser.msgBox("WARNING", "The range 'updateSpreadsheet' used to send data to Fusion has been changed.", Browser.Buttons.OK);
   }
}